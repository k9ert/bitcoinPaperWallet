<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Paper Wallet Transaction Creator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .status-indicator {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .status-online {
            background-color: #ff4444;
            color: white;
        }

        .status-offline {
            background-color: #44ff44;
            color: black;
        }

        .status-test {
            background-color: #ffaa00;
            color: black;
        }

        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            color: #856404;
        }

        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            color: #721c24;
        }

        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            color: #155724;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="text"], input[type="number"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        input:disabled, textarea:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }

        .button {
            background-color: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: background-color 0.3s ease;
        }

        .button:hover:not(:disabled) {
            background-color: #0056b3;
        }

        .button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .button-success {
            background-color: #28a745;
        }

        .button-success:hover:not(:disabled) {
            background-color: #218838;
        }

        .button-danger {
            background-color: #dc3545;
        }

        .button-danger:hover:not(:disabled) {
            background-color: #c82333;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #2196F3;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .transaction-output {
            margin-top: 30px;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .transaction-hex {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            word-break: break-all;
            border: 1px solid #dee2e6;
            margin-bottom: 15px;
        }

        .qr-code {
            text-align: center;
            margin-top: 20px;
        }

        .copy-button {
            position: relative;
            margin-left: 10px;
        }

        .hidden {
            display: none;
        }

        .flex-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .qr-placeholder {
            width: 256px;
            height: 256px;
            border: 2px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            background-color: #f9f9f9;
            color: #666;
            text-align: center;
            font-size: 14px;
            border-radius: 8px;
        }

        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            .flex-container {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Bitcoin Paper Wallet Transaction Creator</h1>
            <div id="status-indicator" class="status-indicator">
                <span id="status-text">Checking connection...</span>
            </div>
        </div>

        <div class="flex-container">
            <label for="test-mode">Test Mode:</label>
            <label class="toggle-switch">
                <input type="checkbox" id="test-mode">
                <span class="slider"></span>
            </label>
            <span class="warning" style="margin: 0; padding: 5px 10px; font-size: 12px;">
                Enable only for development testing
            </span>
        </div>

        <div class="warning">
            <strong>⚠️ SECURITY WARNING:</strong> This application should only be used offline for maximum security. 
            Disconnect from the internet before entering any private keys. The input fields are disabled when online 
            to prevent accidental exposure of sensitive information.
        </div>

        <div id="error-message" class="error hidden"></div>
        <div id="success-message" class="success hidden"></div>

        <form id="transaction-form">
            <div class="form-group">
                <label for="txid">Transaction ID (TXid):</label>
                <input type="text" id="txid" placeholder="Enter the transaction ID of the UTXO (64 hex characters)" disabled>
            </div>

            <div class="form-group">
                <label for="vout">UTXO Index (vout):</label>
                <input type="number" id="vout" placeholder="Enter the index of the UTXO within the transaction" min="0" disabled>
            </div>

            <div class="form-group">
                <label for="private-key">Private Key (WIF format):</label>
                <input type="text" id="private-key" placeholder="Enter your private key starting with 5, K, or L" disabled>
            </div>

            <div class="form-group">
                <label for="target-address">Target Address:</label>
                <input type="text" id="target-address" placeholder="Enter Bitcoin address (legacy 1..., script 3..., or native segwit bc1...)" disabled>
            </div>

            <div class="form-group">
                <label for="amount">Amount (satoshis):</label>
                <input type="number" id="amount" placeholder="Enter amount in satoshis" min="1" disabled>
            </div>

            <div class="form-group">
                <label for="fee">Transaction Fee (satoshis):</label>
                <input type="number" id="fee" placeholder="Enter transaction fee in satoshis" min="1" value="1000" disabled>
            </div>

            <button type="submit" class="button" id="create-tx-btn" disabled>Create Transaction</button>
        </form>

        <div id="transaction-output" class="transaction-output hidden">
            <h3>Transaction Created Successfully</h3>
            <div class="form-group">
                <label for="tx-hex">Transaction Hex:</label>
                <div class="transaction-hex" id="tx-hex"></div>
                <button type="button" class="button copy-button" onclick="copyToClipboard('tx-hex')">Copy Transaction</button>
            </div>
            
            <div class="qr-code">
                <h4>QR Code:</h4>
                <div class="qr-placeholder" id="qr-placeholder">
                    QR code functionality requires external library<br>
                    Use the transaction hex above to broadcast
                </div>
            </div>
        </div>
    </div>

    <!-- Local Bitcoin Library -->
    <script src="bitcoinjs-lib.min.js"></script>
    <script src="qrcode.min.js"></script>

    <script>
        // Global variables
        let isOnline = navigator.onLine;
        let testMode = false;
        
        // Wait for Bitcoin library to load
        let bitcoin = window.bitcoin;

        // DOM elements
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        const testModeToggle = document.getElementById('test-mode');
        const transactionForm = document.getElementById('transaction-form');
        const createTxBtn = document.getElementById('create-tx-btn');
        const transactionOutput = document.getElementById('transaction-output');
        const errorMessage = document.getElementById('error-message');
        const successMessage = document.getElementById('success-message');

        // Form inputs
        const txidInput = document.getElementById('txid');
        const voutInput = document.getElementById('vout');
        const privateKeyInput = document.getElementById('private-key');
        const targetAddressInput = document.getElementById('target-address');
        const amountInput = document.getElementById('amount');
        const feeInput = document.getElementById('fee');

        // Initialize the application
        function init() {
            console.log('Application initialized');
            
            // Re-assign bitcoin in case it wasn't loaded when declared
            if (typeof window.bitcoin !== 'undefined') {
                bitcoin = window.bitcoin;
            }
            
            console.log('Bitcoin library loaded:', typeof bitcoin !== 'undefined');
            console.log('QRCode library loaded:', typeof QRCode !== 'undefined');
            
            // Test Bitcoin library functionality
            testBitcoinLibrary();
            
            updateConnectionStatus();
            setupEventListeners();
            updateFormState();
        }

        // Test Bitcoin library functionality
        function testBitcoinLibrary() {
            if (typeof bitcoin === 'undefined') {
                console.error('Bitcoin library not loaded');
                return;
            }
            
            console.log('Bitcoin library methods available:');
            console.log('- address:', typeof bitcoin.address);
            console.log('- payments:', typeof bitcoin.payments);
            console.log('- Psbt:', typeof bitcoin.Psbt);
            console.log('- Transaction:', typeof bitcoin.Transaction);
            console.log('- TransactionBuilder:', typeof bitcoin.TransactionBuilder);
            console.log('- ECPair:', typeof bitcoin.ECPair);
            console.log('- networks:', typeof bitcoin.networks);
            console.log('- script:', typeof bitcoin.script);
            
            // Test basic functionality
            try {
                // Test address validation
                const testAddress = '1BvBMSEYstWetqTFn5Au4m4GFg7xJaNVN2';
                const outputScript = bitcoin.address.toOutputScript(testAddress);
                console.log('✓ Address validation works');
                
                // Test PSBT creation
                const psbt = new bitcoin.Psbt();
                console.log('✓ PSBT creation works');
                
                // Test network access
                const network = bitcoin.networks.bitcoin;
                console.log('✓ Network access works');
                
                console.log('Bitcoin library integration test: PASSED');
            } catch (error) {
                console.error('Bitcoin library integration test: FAILED', error);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Network status events
            window.addEventListener('online', handleOnline);
            window.addEventListener('offline', handleOffline);

            // Test mode toggle
            testModeToggle.addEventListener('change', handleTestModeToggle);

            // Form submission
            transactionForm.addEventListener('submit', handleTransactionSubmit);

            // Input validation
            const inputs = [txidInput, voutInput, privateKeyInput, targetAddressInput, amountInput, feeInput];
            inputs.forEach(input => {
                input.addEventListener('input', validateForm);
                input.addEventListener('blur', validateForm);
            });
        }

        // Handle online status
        function handleOnline() {
            isOnline = true;
            updateConnectionStatus();
            updateFormState();
        }

        // Handle offline status
        function handleOffline() {
            isOnline = false;
            updateConnectionStatus();
            updateFormState();
        }

        // Handle test mode toggle
        function handleTestModeToggle() {
            testMode = testModeToggle.checked;
            updateConnectionStatus();
            updateFormState();
        }

        // Update connection status display
        function updateConnectionStatus() {
            if (testMode) {
                statusIndicator.className = 'status-indicator status-test';
                statusText.textContent = 'TEST MODE - Development Only';
            } else if (isOnline) {
                statusIndicator.className = 'status-indicator status-online';
                statusText.textContent = 'ONLINE - Inputs Disabled for Security';
            } else {
                statusIndicator.className = 'status-indicator status-offline';
                statusText.textContent = 'OFFLINE - Safe to Use';
            }
        }

        // Update form state based on connection and test mode
        function updateFormState() {
            const shouldEnable = !isOnline || testMode;
            const inputs = [txidInput, voutInput, privateKeyInput, targetAddressInput, amountInput, feeInput];
            
            inputs.forEach(input => {
                input.disabled = !shouldEnable;
            });

            createTxBtn.disabled = !shouldEnable;
            
            if (shouldEnable) {
                validateForm();
            }
        }

        // Validate form inputs
        function validateForm() {
            const inputs = [txidInput, voutInput, privateKeyInput, targetAddressInput, amountInput, feeInput];
            const shouldEnable = !isOnline || testMode;
            
            if (!shouldEnable) {
                createTxBtn.disabled = true;
                return;
            }

            // Check if all fields are filled
            const allFieldsFilled = inputs.every(input => input.value.trim() !== '');
            
            if (!allFieldsFilled) {
                createTxBtn.disabled = true;
                hideError();
                return;
            }

            // Validate specific fields
            try {
                // Validate transaction ID (64 hex characters)
                if (!/^[a-fA-F0-9]{64}$/.test(txidInput.value.trim())) {
                    throw new Error('Transaction ID must be exactly 64 hexadecimal characters');
                }

                // Validate UTXO index
                const vout = parseInt(voutInput.value);
                if (isNaN(vout) || vout < 0) {
                    throw new Error('UTXO index must be a non-negative number');
                }

                // Validate private key (WIF format) - using Bitcoin library
                const privateKey = privateKeyInput.value.trim();
                if (typeof bitcoin !== 'undefined' && bitcoin.ECPair) {
                    try {
                        bitcoin.ECPair.fromWIF(privateKey);
                    } catch (e) {
                        throw new Error('Invalid private key format. Must be valid WIF format.');
                    }
                } else {
                    // Fallback basic validation
                    if (privateKey.length < 51 || privateKey.length > 52) {
                        throw new Error('Private key must be 51-52 characters long (WIF format)');
                    }
                    if (!/^[5KL]/.test(privateKey)) {
                        throw new Error('Private key must start with 5, K, or L (WIF format)');
                    }
                }

                // Validate target address - using Bitcoin library
                const targetAddress = targetAddressInput.value.trim();
                
                // Check for unsupported taproot addresses
                if (targetAddress.startsWith('bc1p')) {
                    throw new Error('Taproot addresses (bc1p...) are not supported. Use legacy (1...) or native segwit (bc1...) addresses only.');
                }
                
                if (typeof bitcoin !== 'undefined' && bitcoin.address) {
                    try {
                        bitcoin.address.toOutputScript(targetAddress);
                    } catch (e) {
                        throw new Error('Invalid Bitcoin address format.');
                    }
                } else {
                    // Fallback basic validation for legacy and native segwit addresses
                    if (targetAddress.length < 26 || targetAddress.length > 42) {
                        throw new Error('Bitcoin address must be 26-42 characters long');
                    }
                    if (!/^[13]/.test(targetAddress) && !targetAddress.startsWith('bc1')) {
                        throw new Error('Bitcoin address must start with 1, 3, or bc1');
                    }
                    // Validate native segwit addresses (but not taproot)
                    if (targetAddress.startsWith('bc1') && !targetAddress.startsWith('bc1p') && targetAddress.length !== 42) {
                        throw new Error('Native segwit addresses must be exactly 42 characters long');
                    }
                }

                // Validate amounts
                const amount = parseInt(amountInput.value);
                const fee = parseInt(feeInput.value);
                
                if (isNaN(amount) || amount <= 0) {
                    throw new Error('Amount must be a positive number');
                }
                
                if (isNaN(fee) || fee <= 0) {
                    throw new Error('Fee must be a positive number');
                }

                createTxBtn.disabled = false;
                hideError();
            } catch (error) {
                createTxBtn.disabled = true;
                showError(`Validation error: ${error.message}`);
            }
        }

        // Handle transaction form submission
        function handleTransactionSubmit(event) {
            event.preventDefault();
            
            if (!isOnline || testMode) {
                createTransaction();
            } else {
                showError('Cannot create transaction while online. Please disconnect from the internet or enable test mode.');
            }
        }

        // Create Bitcoin transaction
        function createTransaction() {
            try {
                hideError();
                hideSuccess();
                
                // Get form values
                const txid = txidInput.value.trim();
                const vout = parseInt(voutInput.value);
                const privateKeyWIF = privateKeyInput.value.trim();
                const targetAddress = targetAddressInput.value.trim();
                const amount = parseInt(amountInput.value);
                const fee = parseInt(feeInput.value);

                // Validate inputs again
                if (!/^[a-fA-F0-9]{64}$/.test(txid)) {
                    throw new Error('Invalid transaction ID format. Must be 64 hexadecimal characters.');
                }

                if (isNaN(vout) || vout < 0) {
                    throw new Error('Invalid UTXO index. Must be a non-negative integer.');
                }

                if (isNaN(amount) || amount <= 0) {
                    throw new Error('Invalid amount. Must be a positive integer in satoshis.');
                }

                if (isNaN(fee) || fee <= 0) {
                    throw new Error('Invalid fee. Must be a positive integer in satoshis.');
                }

                // Create Bitcoin transaction using TransactionBuilder (bitcoinjs-lib 5.x)
                if (typeof bitcoin !== 'undefined' && bitcoin.TransactionBuilder && bitcoin.ECPair) {
                    // Create key pair from private key
                    const keyPair = bitcoin.ECPair.fromWIF(privateKeyWIF, bitcoin.networks.bitcoin);
                    
                    // Create transaction builder
                    const txBuilder = new bitcoin.TransactionBuilder(bitcoin.networks.bitcoin);
                    
                    // Add input
                    txBuilder.addInput(txid, vout);
                    
                    // Add output
                    txBuilder.addOutput(targetAddress, amount);
                    
                    // Sign the input
                    txBuilder.sign(0, keyPair);
                    
                    // Build the transaction
                    const tx = txBuilder.build();
                    const txHex = tx.toHex();
                    
                    displayTransaction(txHex);
                    
                    showSuccess('Bitcoin transaction created and signed successfully!');
                } else {
                    throw new Error('Bitcoin library components not available. Required: TransactionBuilder, ECPair');
                }

            } catch (error) {
                console.error('Transaction creation error:', error);
                showError(`Transaction creation failed: ${error.message}`);
            }
        }

        // Create a demo transaction hex for demonstration
        function createDemoTransactionHex(txid, vout, targetAddress, amount) {
            // Create a basic transaction structure for demonstration
            return createTransactionHex(txid, vout, targetAddress, amount, 1000);
        }

        // Create a basic transaction hex (simplified demonstration)
        function createTransactionHex(txid, vout, targetAddress, amount, fee) {
            // This creates a basic transaction structure for demonstration
            // In real Bitcoin transactions, you need proper signature creation and validation
            
            // Transaction version (4 bytes, little endian)
            const version = '01000000';
            
            // Input count (1 byte)
            const inputCount = '01';
            
            // Previous transaction hash (32 bytes, reversed)
            const prevTxHash = reverseHex(txid);
            
            // Previous output index (4 bytes, little endian)
            const prevOutputIndex = vout.toString(16).padStart(8, '0').match(/.{2}/g).reverse().join('');
            
            // Script length (1 byte) - empty for now
            const scriptLength = '00';
            
            // Sequence (4 bytes)
            const sequence = 'ffffffff';
            
            // Output count (1 byte)
            const outputCount = '01';
            
            // Output value (8 bytes, little endian)
            const outputValue = amount.toString(16).padStart(16, '0').match(/.{2}/g).reverse().join('');
            
            // Output script length (1 byte)
            const outputScriptLength = '19'; // 25 bytes for P2PKH
            
            // Output script (P2PKH: OP_DUP OP_HASH160 <pubkeyhash> OP_EQUALVERIFY OP_CHECKSIG)
            const outputScript = '76a914' + '0'.repeat(40) + '88ac'; // Placeholder pubkey hash
            
            // Lock time (4 bytes)
            const lockTime = '00000000';
            
            const txHex = version + inputCount + prevTxHash + prevOutputIndex + scriptLength + sequence + 
                         outputCount + outputValue + outputScriptLength + outputScript + lockTime;
            
            return txHex;
        }

        // Reverse hex string for little endian
        function reverseHex(hex) {
            return hex.match(/.{2}/g).reverse().join('');
        }

        // Display the created transaction
        function displayTransaction(txHex) {
            // Show transaction hex
            document.getElementById('tx-hex').textContent = txHex;

            // Generate QR code
            if (typeof QRCode !== 'undefined') {
                const qrPlaceholder = document.getElementById('qr-placeholder');
                qrPlaceholder.innerHTML = '<canvas id="qr-canvas"></canvas>';
                
                const qrCanvas = document.getElementById('qr-canvas');
                QRCode.toCanvas(qrCanvas, txHex, {
                    width: 256,
                    margin: 2,
                    color: {
                        dark: '#000000',
                        light: '#FFFFFF'
                    }
                }, function (error) {
                    if (error) {
                        console.error('QR code generation error:', error);
                        qrPlaceholder.innerHTML = 'QR code generation failed<br>Use the hex above to broadcast';
                    }
                });
            } else {
                document.getElementById('qr-placeholder').innerHTML = 
                    'QR code library not available<br>Use the transaction hex above to broadcast';
            }

            // Show the transaction output section
            transactionOutput.classList.remove('hidden');
            
            // Scroll to the output
            transactionOutput.scrollIntoView({ behavior: 'smooth' });
        }

        // Copy text to clipboard
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                showSuccess('Transaction copied to clipboard!');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showSuccess('Transaction copied to clipboard!');
            });
        }

        // Show error message
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            successMessage.classList.add('hidden');
            errorMessage.scrollIntoView({ behavior: 'smooth' });
        }

        // Hide error message
        function hideError() {
            errorMessage.classList.add('hidden');
        }

        // Show success message
        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.classList.remove('hidden');
            errorMessage.classList.add('hidden');
        }

        // Hide success message
        function hideSuccess() {
            successMessage.classList.add('hidden');
        }

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);

        // Additional security warning
        window.addEventListener('beforeunload', function(event) {
            if (privateKeyInput.value.trim() !== '') {
                event.preventDefault();
                event.returnValue = 'You have entered sensitive information. Are you sure you want to leave?';
            }
        });
    </script>
</body>
</html>